humidity:

    mqtt:
       binary_sensor:
          - state_topic: "humidity/mode"
            name: humidity_mode
            payload_on: "ON"
            payload_off: "OFF"  

    binary_sensor:
      - platform: template
        sensors:
        
          humidity:
            friendly_name: "Увлажнение"
            value_template: >-
              {{ is_state('binary_sensor.0x00158d00029b0fd5_contact', 'off')  
                 and is_state('binary_sensor.humidity_mode', 'on')}}
            icon_template: >-
              {% if is_state("binary_sensor.humidity", "on") %}
              mdi:water-percent
              {% else %}
              mdi:air-humidifier
              {% endif %}
    
    switch:
    
      - platform: template
        switches:
          humidity_mode:
            friendly_name: "Режим увлажнения воздуха"
            value_template: "{{  is_state('binary_sensor.humidity_mode', 'on') }}"
            turn_on:
              service: mqtt.publish
              data_template:
                topic: "humidity/mode"
                payload_template: 'ON'
                retain: true 
            turn_off:
              service: mqtt.publish
              data_template:
                topic: "humidity/mode"
                payload_template: 'OFF'
                retain: true 
            icon_template: >-
              {% if is_state("switch.humidity_mode", "on") %}
              mdi:air-humidifier
              {% else %}
              mdi:air-humidifier-off
              {% endif %}
              
    automation:
            
        - id: '1652642961682'
          alias: humidify_on_off
          trigger:
          - platform: homeassistant
            event: start
          - platform: state
            entity_id:
            - sensor.a4c138354dbb_humidity
          - platform: state
            entity_id:
            - binary_sensor.0x00158d00029b0fd5_contact
          - platform: time_pattern
            minutes: '10'
          action:
          - choose:
            - conditions:
              - condition: state
                entity_id: binary_sensor.humidity
                state: 'off'
              sequence:
              - type: turn_off
                device_id: 566c339f3bfd572ca3e3e7d647e1f5e8
                entity_id: humidifier.zhimi_humidifier_ca1
                domain: humidifier
            - conditions:
              - condition: state
                entity_id: binary_sensor.humidity
                state: 'on'
              sequence:
              - type: turn_on
                device_id: 566c339f3bfd572ca3e3e7d647e1f5e8
                entity_id: humidifier.zhimi_humidifier_ca1
                domain: humidifier
            
            
    
